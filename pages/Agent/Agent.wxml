<!--pages/Agent/Agent.wxml-->

<view class="chat-container">
  <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
  <view class="header">
    <view class="status-section">
      <text class="status-value {{isConnected ? 'connected' : 'disconnected'}}">
        {{isConnected ? 'ğŸŸ¢ å·²è¿æ¥' : 'ğŸ”´ æœªè¿æ¥'}}
      </text>
      <text class="welcome-title">æ™ºèƒ½ä½“</text>
    </view>
  </view>
  
<!-- ä¸Šä¸‹æ»šåŠ¨è½®ç›˜ï¼šé€‰æ‹©é¢„è®¾åå­— -->
  <view class="input-picker-group">
    <!-- ä¸Šä¸‹æ»šåŠ¨è½®ç›˜ï¼šé€‰æ‹©é¢„è®¾åå­— -->
    <picker 
      mode="selector" 
      range="{{Agent_Name_List}}"   
      value="{{selectedIndex}}" 
      bindchange="onPickerChange"  
      class="workflow-picker"
    >
      <view class="picker-text">
        {{Agent_List[selectedIndex].name }}
      </view>
    </picker>

    <!-- æ‰‹åŠ¨è¾“å…¥æ¡†ï¼šå¯è¾“å…¥ID/è‡ªå®šä¹‰å†…å®¹ï¼ŒåŒæ­¥é€‰ä¸­çš„è½®ç›˜ID -->
    <input 
      class="chat-input" 
      placeholder="é€‰æ‹©/è¾“å…¥ID" 
      value="{{agent_id}}" 
      bindinput="onIDChange"  
      confirm-type="send"
      bindconfirm="sendMessage"
    />

  </view>

  <text class="workflow-id">æ™ºèƒ½ä½“ID : {{agent_id || 'æœªè®¾ç½®'}}
    ä¼šè¯ID : {{conversation_id || 'æœªè®¾ç½®'}}</text>
    

  
  
  
  <!-- èŠå¤©æ¶ˆæ¯åˆ—è¡¨ -->
  <scroll-view class="messages-container" scroll-y scroll-top="{{scrollTop}}" scroll-with-animation>
    <view class="message-item {{item.type}}-message" wx:for="{{chatMessages}}" wx:key="id">
      <view class="avatar {{item.type}}-avatar">{{item.type === 'user' ? 'æˆ‘' : 'AI'}}</view>
      <view class="message-bubble {{item.type}}-bubble">
        <view class="thinking-section" wx:if="{{item.type === 'ai' && item.history_isexpanded}}">
          <text class="thinking-text">{{item.thinking_content}}</text>
        </view>
        <view class="thinking-toggle" bindtap="change_history_isexpanded" data-index="{{index}}" wx:if="{{item.type === 'ai'}}">
          <text class="toggle-text">{{item.history_isexpanded ? 'ğŸ‘† æ”¶èµ·æ€è€ƒè¿‡ç¨‹' : 'ğŸ‘‡ å±•å¼€æ€è€ƒè¿‡ç¨‹'}}</text>
        </view>
        <!-- <view class="message-content"> -->
        <text class="message-text">{{item.result_content}}</text>
        
        <!-- </view> -->
      </view>
    </view>
    
    <!-- å½“å‰æ­£åœ¨æ¥æ”¶çš„æ¶ˆæ¯ -->
    <view class="message-item ai-message" wx:if="{{receivedData && !isReceivingDone}}">
      <view class="avatar ai-avatar">AI</view>
      <view class="thinking-container" >
      <!-- <view class="message-bubble ai-bubble">  -->
        <text class="thinking-content" wx:if="{{isexpanded}}">
        {{thinkingdata}}
        </text>
        <text bindtap="changeisexpanded" wx:if="{{isexpanded}}">
        ğŸ‘‰ç‚¹å‡»æŠ˜å æ€è€ƒè¿‡ç¨‹</text>
        <view class="thinking-content" bindtap="changeisexpanded" wx:if="{{!isexpanded}}">
          <text>ğŸ‘‰ ç‚¹å‡»å±•å¼€æ€è€ƒè¿‡ç¨‹</text>
        </view>
      </view>
      <view class="message-bubble ai-bubble"> 
        <text class="message-text">{{resultdata}}</text>
      </view>
    </view>

  </scroll-view>
  
  <!-- è¾“å…¥åŒºåŸŸ -->
  <view class="input-area">
    <input 
      class="chat-input" 
      placeholder="è¾“å…¥æ¶ˆæ¯..." 
      value="{{inputMessage}}" 
      bindinput="onInputMessageChange"
      confirm-type="send"
      bindconfirm="sendMessage"
    />
    <button class="send-button" bindtap="sendMessage" disabled="{{!inputMessage || !isConnected}}">
      <text class="send-text">å‘é€</text>
    </button>
  </view>


  <!-- æ§åˆ¶æŒ‰é’® -->
  <view class="button-section">
    <button class="btn connect-btn" bindtap="connectWebSocket" type="primary" hidden>
      è¿æ¥
    </button>
    <button class="btn disconnect-btn" bindtap="disconnectWebSocket" hidden>
      æ–­å¼€
    </button>
    <button class="btn clear-btn" bindtap="clearLog" hidden>
      æ¸…ç©ºæ—¥å¿—
    </button>
  </view>
  
  
  <!-- æ—¥å¿—æ˜¾ç¤º -->
  <view class="log-section" hidden>
    <text class="label">é€šä¿¡æ—¥å¿—:</text>
    <scroll-view class="log-container" scroll-y>
      <view class="log-item {{item.type}}" wx:for="{{logs}}" wx:key="index">
        <text class="log-time">{{item.time}}</text>
        <text class="log-content">{{item.content}}</text>
      </view>
    </scroll-view>
  </view>





</view>
  


  

  
  